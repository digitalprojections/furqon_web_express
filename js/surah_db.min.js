function show_surah_content(e){sdb.close(),manage_object_stores(databaseName,selected_surah,e)}function show_surah_content_now(){var e=document.getElementById("infinite-list"),t=big_data.length;console.log(e),e.delegate={createItemContent:function(e){return create_row(e)},countItems:function(){return t}},e.refresh(),$("#surahaudio").off().on("pause",function(){save_playposition()}),Boolean(localStorage.first_surah)||(localStorage.first_surah="done",showPopover(document.getElementsByClassName("ayah_id")[0]),document.getElementById("poptext").innerHTML=lang[language].chapter_loaded),restore_bookmark()}function restore_bookmark(){try{set_bookmarks()}catch(e){}}function ayah_click(e){$(e.currentTarget).find(".expandable-content").is(":visible")?($(e.currentTarget).find(".qavs_ichi").hide(),$(e.currentTarget).find(".zmdi-code-setting").show()):(e.currentTarget.showExpansion(),$(e.currentTarget).find(".qavs_ichi").show(),$(e.currentTarget).find(".zmdi-code-setting").hide()),console.log($(e.currentTarget).find(".expandable-content").eq(0).is(":visible"))}function set_bookmarks(){if(bookmarklist[selected_surah])if($("#ayah-"+selected_surah+"-"+bookmarklist[selected_surah]).length>0){$("#loading_circle").css("display","none"),console.log("surah and ayah",selected_surah,bookmarklist[selected_surah]),document.querySelector("#ayah-"+selected_surah+"-"+bookmarklist[selected_surah]).scrollIntoView(),$("#ayah-"+selected_surah+"-"+bookmarklist[selected_surah])[0].getElementsByClassName("zmdi")[0].classList.remove("zmdi-bookmark-outline"),$("#ayah-"+selected_surah+"-"+bookmarklist[selected_surah])[0].getElementsByClassName("zmdi")[0].classList.add("zmdi-bookmark");setTimeout(function(){console.log("sttt")},300);ons.notification.toast(lang[language].bookmark_found_message+bookmarklist[selected_surah],{timeout:1e3,animation:"fall"})}else{console.log("settimeout");var e=$(".list-item");e[e.length-1].scrollIntoView({behavior:"instant"}),setTimeout(function(){set_bookmarks()},300)}else document.querySelector("#loading_circle").hide();playpositions[selected_surah]&&($("#surahaudio")[0].currentTime=playpositions[selected_surah]-5)}function create_row(e){var t;if(1==big_data[e].DatabaseID){var a=document.createElement("ons-list-item");a.id="ayah-"+big_data[e].SuraID+"-"+big_data[e].VerseID,a.setAttribute("onclick","ayah_click(event)"),a.setAttribute("modifier","tappable");var o=document.createElement("ons-row"),n=document.createElement("ons-col"),s=document.createElement("span");s.setAttribute("class","ayah_id"),s.innerText=big_data[e].VerseID,n.appendChild(s),o.appendChild(n),a.appendChild(o);var r=document.createElement("ons-row"),i=document.createElement("ons-col");i.setAttribute("class","arabic");var l=document.createElement("span");l.setAttribute("class","ayah_text arabic"),l.innerText=big_data[e].AyahText,i.appendChild(l),r.appendChild(i),a.appendChild(r),t=a}else{var c=big_data[e].AyahText.replace(/\(/g,'<i class="zmdi zmdi-code-setting"></i><span class="qavs_ichi">');c=c.replace(/\)/g,"</span>");var d=ons.createElement("<ons-list-item>");d.setAttribute("modifier","tappable"),d.setAttribute("expandable",""),d.setAttribute("onclick","ayah_click(event)"),d.id="ayah-"+big_data[e].SuraID+"-"+big_data[e].VerseID;var r=document.createElement("ons-row"),i=document.createElement("ons-col"),u=document.createElement("i");u.setAttribute("class","zmdi zmdi-bookmark-outline");var s=document.createElement("span");s.setAttribute("class","ayah_id"),s.innerText=big_data[e].VerseID,d.appendChild(r),r.appendChild(i),i.appendChild(u);var m=document.createElement("ons-row"),g=document.createElement("ons-col"),b=document.createElement("div");b.setAttribute("class","ayah_text");var h=document.createElement("ons-button");h.setAttribute("onmousedown","bookmark_ayahid(event)"),h.setAttribute("chapter_no",big_data[e].SuraID),h.setAttribute("ayah_no",big_data[e].VerseID);var p=document.createElement("ons-icon");p.setAttribute("icon","md-bookmark"),h.appendChild(p);var _=document.createElement("ons-button");_.setAttribute("onmousedown","share_ayah(event)"),_.setAttribute("chapter_no",big_data[e].SuraID),_.setAttribute("ayah_no",big_data[e].VerseID);var f=document.createElement("ons-icon");f.setAttribute("icon","md-share"),_.appendChild(f);var l=document.createElement("span");l.setAttribute("class","oyatmatni"),l.innerHTML=c,g.appendChild(l),d.appendChild(m),m.appendChild(g);var k=document.createElement("div");k.setAttribute("class","expandable-content"),k.appendChild(s),k.appendChild(b),b.appendChild(h),b.appendChild(_),d.appendChild(k),t=d}return t}function share_ayah(e){var t={message:e.currentTarget.parentElement.parentElement.parentElement.getElementsByClassName("oyatmatni")[0].innerText+" (Qur'an, "+e.currentTarget.getAttribute("chapter_no")+":"+e.currentTarget.getAttribute("ayah_no")+");",subject:"the subject"},a=function(e){console.log("Share completed? "+e.completed),console.log("Shared to app: "+e.app)},o=function(e){console.log("Sharing failed with message: "+e)};window.plugins.socialsharing.shareWithOptions(t,a,o)}function save_playposition(){var e=Math.floor(document.querySelector("#surahaudio").currentTime);console.log("save_playposition",selected_surah,e),playpositions[Number(selected_surah)]=Number(e),localStorage.playpositions=JSON.stringify(playpositions),ons.notification.toast(lang[language].playposition_text,{timeout:1e3,animation:"fall"})}function bookmark_ayahid(e){var t=Number(e.currentTarget.getAttribute("chapter_no")),a=Number(e.currentTarget.getAttribute("ayah_no"));console.log(t,a),bookmarklist[Number(t)]=Number(a),localStorage.bookmarklist=JSON.stringify(bookmarklist),$(".zmdi-bookmark").removeClass("zmdi-bookmark").addClass("zmdi-bookmark-outline");var o=e.currentTarget.parentElement.parentElement.parentElement.getElementsByClassName("zmdi-bookmark-outline")[0];o.classList.remove("zmdi-bookmark-outline"),o.classList.add("zmdi-bookmark")}function manage_object_stores(e,t,a){var o=indexedDB.open(e);o.onsuccess=function(o){sdb=o.target.result;var n=parseInt(sdb.version);if(console.log("checking the store",sdb),sdb.objectStoreNames.contains(t))console.log("secondRequest"),startTransaction(a);else{sdb.close();var s=indexedDB.open(e,n+1);console.log("manage stores is processing version upgrade",n,s),s.onupgradeneeded=function(e){sdb=e.target.result;try{console.log("upgrading",n+1);var a=sdb.createObjectStore(t,{autoIncrement:!0});a.createIndex("VerseID","VerseID",{unique:!1}),a.createIndex("DatabaseID","DatabaseID",{unique:!1}),a.createIndex("SuraID","SuraID",{unique:!1})}catch(e){console.log(e.message)}},s.onsuccess=function(e){e.target.result.close(),console.log("new data store created"),startTransaction(a)},s.onerror=function(e){console.log(e.target.error.message,"store Name failed to create?")}}},o.onerror=function(e){console.log(e.type)}}function startTransaction(e){var t=indexedDB.open(databaseName);t.onsuccess=function(t){sdb=t.target.result;var a=sdb.transaction([selected_surah],"readwrite"),o=a.objectStore(selected_surah);e.forEach(function(e){var t=o.put(e);t.onsuccess=function(e){},t.oncomplete=function(e){}}),a.oncomplete=function(e){console.log("All done!"),get_by_suraid()},a.onerror=function(e){console.log("error! "+e.target.error.message)}},t.onerror=function(e){}}function get_by_suraid(){if(console.log("get_by_surah"),sdb.objectStoreNames.contains(selected_surah)){document.querySelector("#loadingtitle").innerHTML=lang[language].loading,document.querySelector("#loading_circle").show(),console.log(selected_surah,"exists, proceed to data retrieval");var e=sdb.transaction(selected_surah,"readonly").objectStore(selected_surah),t=e.index("SuraID");keyRange=IDBKeyRange.only(["SuraID"]),console.log(t);var a=t.count(keyRange);a.onsuccess=function(e){big_data=[];var o=e.target.result;console.log(o,"row counts"),a=t.openCursor(),a.onsuccess=function(e){var t=e.target.result;t?(languageID(t.value.DatabaseID)&&big_data.push(t.value),t.continue()):big_data.length>0?show_surah_content_now():(console.log(big_data.length,"big data empty for ",selected_surah),ajax(izoh_data))},console.log(o,"cursor length")},a.onerror=function(e){console.log(e,"error loading data")}}else sdb.close(),console.log("closed sdb, selected_surah does not exist, will CREATE a store now")}function languageID(e){e=Number(e);for(var t,a=0;a<languages.length;a++)languages[a]===e&&(t=!0);return t}function check_store(e){return!!sdb.objectStoreNames.contains(e)}var sdb,big_data=[],databaseName="suralar",izoh_data;if(window.indexedDB){console.log("sdb initiated");var request=indexedDB.open(databaseName);request.onsuccess=function(e){sdb=e.target.result}}else window.alert("Your browser doesn't support a stable version of IndexedDB. Some features will not be available.");